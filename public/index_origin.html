<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>プリマーテテストチェック</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/6.0.2/firebase-app.js"></script>

    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>

  </head>
  <body>
  下記のフォームからアイテムを選択してください。(表示時にapiも叩く)
  <form name="line">
    <input name="lineid" value="" placeholder="id"><br>
    <select name="item_1">
      <option value="なし">（アイテム1）</option>
    </select><br>
    <select name="item_2">
      <option value="なし">（アイテム2）</option>
    </select><br>
  </form>
    <button onClick="sendMessage()">Close&Message</button><br>
    <button onClick="makeApiCall()">API Call</button>
    <script>
      var userId='';
      function sendMessage(){
        liff.sendMessages([
          {
            type:'text',
            text:'My LINE_ID is '+userId+'\n'+'SELECTED Item is'+document['line']['item_1']
          }
        ])
        .then(() => {
          console.log('message sent');
          liff.closeWindow();
        })
        .catch((err) => {
          console.log('error', err);
        });
      }


      function makeApiCall(){
        var params = {
          // The ID of the spreadsheet to retrieve data from.
          spreadsheetId: '1jfk6sun0o9sDgoDboeW6cNNpCyMcTHZ8_NbtgOLVtJ0',  // TODO: Update placeholder value.

          // The A1 notation of the values to retrieve.
          range: 'A1:F100',  // TODO: Update placeholder value.

        };

        var request = gapi.client.sheets.spreadsheets.values.get(params);
        request.then(function(response) {
          // TODO: Change code below to process the `response` object:
          var resultSet = response.result.values;
          document.line.item_1.length = resultSet.length;
          for(var i=0;i<resultSet.length;i++){
            document.line.item_1.options[i].text=resultSet[i][1];
            document.line.item_1.options[i].values=resultSet[i][1];
          }
          console.log(response.result);
        }, function(reason) {
          console.error('error: ' + reason.result.error.message);
        });
      }

      function initClient() {
        var API_KEY = 'AIzaSyDfw-SfHNlDxJs4cx76Le1NjT37rqQ3Dek';  // TODO: Update placeholder with desired API key.

        var CLIENT_ID = '671785311085-g7ge1u8bngr4dcqvgnbk7u0pb6nue5f7.apps.googleusercontent.com';  // TODO: Update placeholder with desired client ID.

        // TODO: Authorize using one of the following scopes:
        //   'https://www.googleapis.com/auth/drive'
        //   'https://www.googleapis.com/auth/drive.file'
        //   'https://www.googleapis.com/auth/drive.readonly'
        //   'https://www.googleapis.com/auth/spreadsheets'
        //   'https://www.googleapis.com/auth/spreadsheets.readonly'
        var SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

        gapi.client.init({
          'apiKey': API_KEY,
          'clientId': CLIENT_ID,
          'scope': SCOPE,
          'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        }).then(function() {
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
          updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        });
      }

      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      function updateSignInStatus(isSignedIn) {
        if (isSignedIn) {
          makeApiCall();
        }
      }

      function handleSignInClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      function handleSignOutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }
      </script>
      <script src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad();"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
      </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {//元はDOMContentLoaded
        try {
          //let app = firebase.app();
          //let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
          liff.init(
            data => {
              // Now you can call LIFF API
              userId = data.context.userId;
              document['line']['lineid']['value']=userId;//LINE IDの格納NG
              //makeApiCall();
            },
            err => {
              // LIFF initialization failed
            }
          );


        } catch (e) {
          console.error(e);
        }
      });
      document.addEventListener('onload', function(){
        makeApiCall();
      });
    </script>
  </body>
</html>
